define(["jquery","version!fly/managers/debug","version!components/form-validate","translations/email-contact","components/modal-async","version!fly/components/loading","version!fly/components/base"],function(a,e,t,o){var r=a.support.touch?"vclick":"click",n=a.fly.loading(),l=e.init("emailContact");a.widget("tr.emailContact",a.fly.base,{options:{modalAsync:{action:null,requestData:{},urls:{shareArticle:"/user/share-email/xhr/",contactAuthor:"/user/contact-author/xhr/"}}},modal:null,_create:function(){this._setup(),this._setupEvents()},_setupEvents:function(){var a={};a[r]="_handleAsyncModal",this._on(this.$element,a)},_handleAsyncModal:function(e){var t=this;e.preventDefault(),this.modal&&this.modal.$element.remove(),this.modal=a.tr.modalAsync(a.extend(!0,{},{openOnInit:!0},this.options.modalAsync)),this.modal.$element.on("modalasynccontentset",function(a,e){t._handleContactFormEvents(e.$modal)})},_handleContactFormEvents:function(e){var t=a(e.find("form")),r=t.find("button, input, textarea"),s=a('[data-component="recaptcha"]',t);n.$element.appendTo(t),t.formValidate({success:function(e,d){e.preventDefault();var i=t.serialize();r.attr("disabled","disabled"),n.add(),a.ajax({url:t.attr("action"),type:t.attr("method"),data:i,dataType:"json"}).done(function(a){l.log("success",a),a.errors?a.errors.recaptcha?t.data("formValidate").addGlobalError(o.error,"error"):a.errors.emptyBody?t.data("formValidate").addGlobalError(o.noBlank,"error"):t.data("formValidate").addGlobalError(o.tryAgain,"error"):a.messages.error?t.data("formValidate").addGlobalError(a.messages.error,"error"):(t.data("formValidate").addGlobalError(o.emailSent,"success"),t[0].reset())}).fail(function(a){l.log("error",a),t.data("formValidate").addGlobalError(o.tryAgain,"error")}).always(function(a){l.log("complete",a),r.removeAttr("disabled"),n.remove(),s.recaptcha("reload")})}})}})});