define(["jquery","version!fly/managers/debug","version!fly/managers/components","version!fly/utils/object-helper","version!fly/components/modal","version!fly/components/loading","version!fly/components/modal-async"],function(t,o,s,e){var i=(o.get("modalAsync"),t.support.touch?"vclick":"click");t.widget("tr.modalAsync",t.fly.modalAsync,{options:{responseKey:"content"},_create:function(){var o=this.options,s="fixed"===o.position?" "+o.classFixed:"",e={},n={},a={};this._setup(),this.$body=t(document.body),this.$modal=t("<div>").addClass(o.classModal).addClass(o.classModal+"-"+o.action).appendTo(this.$body),this.$backdrop=t("<div>").addClass(o.classBackdrop+s),this.top=parseInt(this.$element.css("top"),10),this.eventData={$modal:this.$modal,$backdrop:this.$backdrop},e[i]="_handleClose",n[i+' [data-close="modal"]']="_handleClose",a[i]="open",this._on(this.$backdrop,e),this._on(this.$modal,n),this._on(this.$element,a),this._setupLoader()},_setupLoader:function(){this.loader=t.fly.loading(this.options.loader),this.loader.$element.appendTo(this.$modal)},open:function(){var t=this.options;this.isOpen||(this.isContentLoaded||this.loadContent(),!1!==this._trigger("open",null,this.eventData)&&(this.$backdrop.addClass(t.classShow).appendTo(this.$body),this.$modal.addClass(t.classShow).appendTo(this.$body),this.position(),this.isOpen=!0,this._trigger("opened",null,this.eventData)))},loadContent:function(){var o=this.options,s=this;this.loader.add(),t.ajax({dataType:"json",url:o.urls[o.action],data:o.requestData}).done(function(i){var n=e.deepFind(i,o.responseKey)||{};if(!n)return void s.destroy();s._trigger("contentLoaded",null,t.extend({},this.eventData,{content:n})),s.isContentLoaded=!0,s.setContent(n),s.$backdrop.css({height:s.$document.height()})}).fail(function(t,o){s.destroy()}).always(function(){s.loader.remove()})},position:function(){var t=this.options,o=this.$window.height(),s=isNaN(this.top)?(o-this.$modal.outerHeight())/3:this.top;s<20&&(s=20),"absolute"==t.position&&("top"==t.place?s=this.$window.scrollTop():s+=this.$window.scrollTop(),this.$backdrop.css({height:this.$document.height()})),this.$modal.css({top:s}),this._trigger("positioned",null,{$modal:this.$modal})},_destroy:function(){this._trigger("destroy"),this._super(),this.$modal.remove()}})});